---
title: "ã‚‚ã†æ€–ããªã„TypeScriptã®Decoratoræ©Ÿèƒ½"
emoji: "ğŸ°"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["typescript"]
published: false
---

# ã¯ã˜ã‚ã«

Nest.js ã‚’å§‹ã‚ã‚‹å‰ã«è‚ã¨ãªã‚‹ TS ã® Decorator æ©Ÿèƒ½ã«ã¤ã„ã¦å­¦ç¿’ã—ãŸã»ã†ãŒã‚ˆã„ã¨æ€ã„ã€å­¦ç¿’ã—ãŸã¨ãã®ãƒ¡ãƒ¢ã§ã™ã€‚

# ãƒªãƒã‚¸ãƒˆãƒªãƒªãƒ³ã‚¯

æœ¬è¨˜äº‹ã§è¨˜è¼‰ã—ã¦ã„ã‚‹ã‚³ãƒ¼ãƒ‰ã¯ã“ã¡ã‚‰ã‹ã‚‰ã€‚

TODO: ãƒªãƒã‚¸ãƒˆãƒªãƒªãƒ³ã‚¯ã€‚

# Decorator ã¨ã¯

Decoratorï¼ˆãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ï¼‰ã¯ã‚¯ãƒ©ã‚¹ã®å®£è¨€ãªã©ã«çµã³ä»˜ã‘ã‚‰ã‚Œã‚‹ç‰¹åˆ¥ãªå®£è¨€ã®ï¼‘ã¤ã€‚`@expression` ã®å½¢å¼ã§å®£è¨€ã™ã‚‹ã€‚æ—¢å­˜ã®ã‚¯ãƒ©ã‚¹ã‚„ãƒ¡ã‚½ãƒƒãƒ‰ã«ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹ï¼ˆ=è¿½åŠ æ©Ÿèƒ½ã‚’å…¥ã‚Œã‚‹ï¼‰ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã—ã‚‡ã†ã‹ã€‚

Decorator ã®è¨­ç½®ã¯ã“ã‚“ãªæ„Ÿã˜ã€‚

```ts
@hoge
class Fuga {
  fuga: string;

  constructor(f: string) {
    this.fuga = t;
  }
}
```

ã¡ãªã¿ã« TS ã ã‘ã§ãªãã€Python ãªã©ä»–ã®è¨€èªã«ã‚‚å­˜åœ¨ã™ã‚‹æ©Ÿèƒ½ã§ã™ã€‚

# Decorator Factories: ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ»ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¼

Decorator Factoriesï¼ˆãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ»ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¼ï¼‰ã¨ã¯ã€è¨­ç½®ã—ãŸãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã«ã‚ˆã£ã¦å‘¼ã³å‡ºã•ã‚Œã‚‹å¼ã‚’è¿”ã™ã‚·ãƒ³ãƒ—ãƒ«ãªé–¢æ•°ã§ã™ã€‚ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã«ã‚ˆã£ã¦é©ç”¨ã•ã‚Œã‚‹æ–¹æ³•ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ãŸã„å ´åˆã«ä½œæˆã—ã¾ã™ã€‚

ã‚³ãƒ¼ãƒ‰ä¾‹ã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã§ã™ã€‚ã“ã“ã§ `target` ã¨ `value` ã®ï¼’å¤‰æ•°ãŒç™»å ´ã—ã¾ã™ãŒã€ã“ã“ã¯ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã®è¨­ç½®å ´æ‰€ã«ã‚ˆã£ã¦ã€æ„å‘³åˆã„ãŒå¤‰ã‚ã£ã¦ãŠãã®ã§ä¸€æ—¦ã“ã“ã§ã¯ç½®ã„ã¦ãŠãã¾ã™ã€‚

```ts
// Decorator Factoryã®å®£è¨€
function factoryMethod(value: string) {
  // Decoratorã«ã‚ˆã£ã¦å‘¼ã³å‡ºã•ã‚Œã‚‹é–¢æ•°
  return function (target) {
    // `target`ã¨`value`ä½¿ã£ã¦å‡¦ç†ã®å†…å®¹ã‚’å®šç¾©
  };
}
```

# Decorator ã®è©•ä¾¡é †

TODO: ã“ã‚Œã¯å¾Œã§æ›¸ãã€‚

# Decorator ã‚’ä»˜ã‘ã‚‰ã‚Œã‚‹å ´æ‰€

ä»˜ã‘ã‚‰ã‚Œã‚‹å ´æ‰€ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

- ã‚¯ãƒ©ã‚¹å®£è¨€ -> Class Decorators: ã‚¯ãƒ©ã‚¹ãƒ»ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿
- ãƒ¡ã‚½ãƒƒãƒ‰ -> Method Decorators: ãƒ¡ã‚½ãƒƒãƒ‰ãƒ»ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿
- ã‚¢ã‚¯ã‚»ã‚µ -> Accessor Decorators: ã‚¢ã‚¯ã‚»ã‚µãƒ»ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿
- ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ -> Property Decorators: ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãƒ»ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿
- ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ -> Parameter Decorators: ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ãƒ»ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿

ä»Šå›ã¯ `Class Decorators` / `Method Decorators` / `Property Decorators` ã®ï¼“ã¤ã«ã¤ã„ã¦ã€é †ç•ªã«æ¦‚è¦/å®Ÿè£…æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¦ã„ãã¾ã™ã€‚

# å„ Decorator ã®ç´¹ä»‹

## Class Decorators: ã‚¯ãƒ©ã‚¹ãƒ»ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿

Class Decoratorï¼ˆã‚¯ãƒ©ã‚¹ãƒ»ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ï¼‰ã¯ã€ã‚¯ãƒ©ã‚¹ã®å®šç¾©ã®æ¤œæŸ»/ä¿®æ­£/ç½®æ›ãŒå‡ºæ¥ã¾ã™ã€‚ã‚¯ãƒ©ã‚¹å®£è¨€ã®ç›´å‰ã§å®£è¨€ã—ã€ã‚¯ãƒ©ã‚¹ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã«é©ç”¨ã•ã‚Œã¾ã™ã€‚

ä¾‹ãˆã° `BaseEntity` ã¨ã„ã†å„ã‚¯ãƒ©ã‚¹ã®ãƒ™ãƒ¼ã‚¹ç”¨ã‚¯ãƒ©ã‚¹ã‚’è¨­ç½®ã—ã€å„ã‚¯ãƒ©ã‚¹ã‚’ `extends` ã—ã¦ã„ãã¨ã—ã¾ã—ã‚‡ã†ã€‚

```ts
class BaseEntity {
  readonly id: number;
  readonly created: string;
  constructor() {
    this.id = Math.random();
    this.created = new Date().toLocaleDateString();
    this.updated = new Date().toLocaleDateString();
  }
}

class Course extends BaseEntity {
  constructor(public name: string) {
    super();
  }
}
class Subject extends BaseEntity {
  constructor(public name: string) {
    super();
  }
}
class Student extends BaseEntity {
  constructor(public name: string) {
    super();
  }
}

const mathCourse = new Course("English");
console.log("id: " + mathCourse.id);
console.log("created: " + mathCourse.created);

const john = new Student("John Doe");
// ...
```

ãŸã ã—ã€ã“ã®æ›¸ãæ–¹ã ã¨ï¼‘ã¤å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚`BaseEntity` ã‚¯ãƒ©ã‚¹ã‹ã‚‰ `extends` ã—ã¦ã„ã‚‹ã‚¯ãƒ©ã‚¹ã®æ•°ãŒå¢—ãˆã¦æ¥ãŸå ´åˆã§ã™ã€‚

å®£è¨€ã™ã‚‹åº¦ã«ä½•åº¦ã‚‚ `extends`ã€œ`super()` ã™ã‚‹å¿…è¦ãŒå‡ºã¦ã—ã¾ã™ã€‚ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹ã‚’ä½¿ã†ä»¥ä¸Šã€ã‚‚ã†å°‘ã—è‰¯ã„æ–¹æ³•ã¯ãªã„ã®ã§ã—ã‚‡ã†ã‹ã€‚ã“ã“ã§ Class Decorator ã®å‡ºç•ªã§ã™ã€‚å…ˆç¨‹ã®ã‚³ãƒ¼ãƒ‰ã‚’ Class Decorator ã‚’ä½¿ç”¨ã—ãŸå½¢ã«æ›¸ãæ›ãˆã¦ã¿ã¾ã—ã‚‡ã†[^1]ã€‚

[^1]: å…¬å¼ã§ã¯ Decorator Factories ã®å‹å®šç¾©ãŒã€`<T extends { new (...args: any[]): {} }>` ã§è¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ãŒã€æœ¬è¨˜äº‹ã§ã¯ TS ã«æ…£ã‚Œã¦ã„ãªã„æ–¹ã§ã‚‚ã‚ã‹ã‚Šã‚„ã™ã„ã‚ˆã†ã« `Function` ã§å®šç¾©ã™ã‚‹æ–¹æ³•ã‚’å–ã‚‰ã›ã¦ã„ãŸã ãã¾ã—ãŸã€‚å…¬å¼ãƒšãƒ¼ã‚¸ã¯ã“ã¡ã‚‰ â†’ https://www.typescriptlang.org/docs/handbook/decorators.html#class-decoratorsã€‚

```ts
// Decorator Factoriesã‚’å®šç¾©
const BaseEntity = (ctr: Function) => {
  ctr.prototype.id = Math.random();
  ctr.prototype.created = new Date().toLocaleString("es-ES");
};

@BaseEntity
class Course {
  constructor(public name: string) {}
}

@BaseEntity
class Subject {
  constructor(public name: string) {}
}

@BaseEntity
class Student {
  constructor(public name: string) {}
}

// å‹ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹ãŸã‚ã€@ts-ignoreã—ã¦ã„ã‚‹
const mathCourse = new Course("English");
// @ts-ignore
console.log("id: " + mathCourse.id);
// @ts-ignore
console.log("created: " + mathCourse.created);

const john = new Student("John Doe");
// ...
```

`@BaseEntity` ã‚’ã‚¯ãƒ©ã‚¹å®£è¨€æ™‚ã«è¨­ç½®ã™ã‚‹ã ã‘ã§ã€ã‚¯ãƒ©ã‚¹ã®æ‹¡å¼µãŒå¯èƒ½ã«ãªã‚Šã¾ã—ãŸã€‚å®Ÿè¡Œã‚‚å‡ºæ¥ã¾ã™ã€‚

ãŸã ã—ã€ï¼‘ç‚¹æ³¨æ„ãŒå¿…è¦ãªã®ã¯ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãªã©ã§ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã§å®šç¾©ã—ãŸã‚¯ãƒ©ã‚¹ç”¨ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’å‘¼ã¼ã†ã¨ã™ã‚‹ã¨ã€TS ã«ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã«ã‚ˆã£ã¦ã‚¯ãƒ©ã‚¹ãŒæ‹¡å¼µã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒä¼ã‚ã£ã¦ã„ãªã„ãŸã‚ã€å‹ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã™ã€‚ã“ã‚Œã¯é•·å¹´ GitHub ã® issue ã«ã‚‚ä¸ŠãŒã£ã¦ãŠã‚Šã€ç›´è¿‘ã®ã‚³ãƒ¡ãƒ³ãƒˆã§ã¯æ ¹æœ¬çš„ãªè§£æ±ºã«ã‚‚ã†å°‘ã—æ™‚é–“ãŒã‹ã‹ã‚‹ã®ã§ã¯ãªã„ã‹ã¨ã„ã†è©±ã‚‚æµ®ä¸Šã—ã¦ã„ã¾ã™ã€‚èˆˆå‘³ã®ã‚ã‚‹æ–¹ã¯è¦—ã„ã¦ã¿ã¦ãã ã•ã„ã€‚

https://github.com/microsoft/TypeScript/issues/4881

## Method Decorators: ãƒ¡ã‚½ãƒƒãƒ‰ãƒ»ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿

Method Decoratorsï¼ˆãƒ¡ã‚½ãƒƒãƒ‰ãƒ»ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ï¼‰ã¯ã€ãƒ¡ã‚½ãƒƒãƒ‰ã®å®šç¾©ã®æ¤œæŸ»/ä¿®æ­£/ç½®æ›ãŒå‡ºæ¥ã¾ã™ã€‚ãƒ¡ã‚½ãƒƒãƒ‰å®šç¾©ã®ç›´å‰ã§å®£è¨€ã—ã¾ã™ã€‚

Method Decorators ã® Decorator Factories å®šç¾©ã¯å°‘ã—ç‰¹æ®Šã§ã™ã€‚ä»¥ä¸‹ã®ï¼“å¼•æ•°ãŒå¿…è¦ã¨ãªã‚Šã¾ã™ã€‚

- `target`: ã‚¯ãƒ©ã‚¹ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã®ãƒ¡ã‚½ãƒƒãƒ‰æœ¬ä½“ã€‚ä½¿ã†æ©Ÿä¼šã¯å°‘ãªã„ã€‚
- `propertyKey`: ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã‚’è¨­ç½®ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã®åå‰ã€‚
- `descriptor`: ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã‚’è¨­ç½®ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã®[`Property Descriptor`](https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/Object/getOwnPropertyDescriptor)ã€‚ä»Šå›ã¯ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã›ã‚‹ã‚‚ã®ã¨è¦šãˆã¦ã‚‚ã‚‰ãˆã°ã„ã„ã§ã™ã€‚

Method Decorators ã® Decorator Factories ã®ã‚³ãƒ¼ãƒ‰ä¾‹ã¯ã“ã¡ã‚‰ã€‚
ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã‚’è¨­ç½®ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã®å‡¦ç†å†…å®¹ã‚’ä¸Šæ›¸ãã™ã‚‹ã“ã¨ã‚’å¼·èª¿ã™ã‚‹ãŸã‚ã€ã‚ã‚‹æ¡ä»¶ã«ãªã£ãŸã¨ãã€å…ƒã®å®šç¾©ã‚’ä¸Šæ›¸ãã—ã¦æ›ã‘ç®—ã‚’å®ŸåŠ¹ã™ã‚‹ `checkCalculate` ã‚’ä½œæˆã—ã¾ã—ãŸã€‚

```ts
function checkCalculate(num: number) {
  return (
    _target: Object,
    _propertyKey: string,
    descriptor: PropertyDescriptor
  ) => {
    const addFunc = descriptor.value;
    descriptor.value = function (...args: number[]) {
      // apply() ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã£ã¦ã€ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã‚’è¨­ç½®ã™ã‚‹å…ƒãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã™
      const result = addFunc.apply(this, args);
      // å…ƒãƒ¡ã‚½ãƒƒãƒ‰ã®è¿”å´å€¤ãŒ10æœªæº€ã®ã¨ãã¯ã€æ›ã‘ç®—ã‚’å®Ÿè¡Œã™ã‚‹
      return result < 10 ? result * num : result;
    };
  };
}
```

ã§ã¯æ—©é€Ÿ `checkCalculate` ã‚’ä½¿ã£ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```ts
class Calculate {
  @checkCalculate(10)
  sum(a: number, b: number): number {
    return a + b;
  }
}

// 50 -> 1 + 4 = 5ã‚’å®Ÿè¡Œã—ãŸå¾Œã«ã€5 < 10ã ã£ãŸãŸã‚æ›´ã«5 x 10 = 50ã‚’è¿”ã™
console.log(new Calculate().sum(1, 4));
// 21 -> 20 + 1 = 21ã‚’å®Ÿè¡Œã—ãŸå¾Œã«ã€21 > 10ã ã£ãŸãŸã‚ã€æ›ã‘ç®—ã¯å®Ÿè¡Œã›ãšãã®ã¾ã¾21ã‚’è¿”ã™
console.log(new Calculate().sum(20, 1));
```

# å‚è€ƒãƒšãƒ¼ã‚¸

- [å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://www.typescriptlang.org/docs/handbook/decorators.html)
  - [æ—¥æœ¬èªè¨³](https://mae.chab.in/archives/59845) â€»2017 å¹´æŠ•ç¨¿ã§ã¡ã‚‡ã£ã¨å¤ã‚
- [Exploring Decorators in TypeScript](https://betterprogramming.pub/decorators-in-typescript-dc47aace075e)
- [TypeScript ã«ã‚ˆã‚‹ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã®åŸºç¤ã¨å®Ÿè·µ](https://qiita.com/taqm/items/4bfd26dfa1f9610128bc)
- [TypeScript ã® Decorator ã¾ã¨ã‚](https://qiita.com/tminasen/items/a449826e35ab83c1a57b)
- https://miyahara.hikaru.dev/posts/20190916/
- https://shakil.me/understanding-typescript-decorators/

- class
  - https://dev.to/danywalls/decorators-in-typescript-with-example-part-1-m0f
